# Migration `20200930170713-add-order`

This migration has been generated by Michal Miszczyszyn at 9/30/2020, 7:07:13 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."OrderStatus" AS ENUM ('PENDING', 'PROCESSING', 'ON_HOLD', 'COMPLETED', 'CANCELLED', 'REFUNDED', 'FAILED')

CREATE TABLE "public"."Cart" (
"id" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."CartToProduct" (
"cartId" text   NOT NULL ,
"productId" integer   NOT NULL ,
"quantity" integer   NOT NULL DEFAULT 1,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("cartId","productId")
)

CREATE TABLE "public"."Order" (
"id" text   NOT NULL ,
"cart" jsonb   NOT NULL ,
"total" integer   NOT NULL ,
"stripePaymentIntentId" text   ,
"status" "OrderStatus"  NOT NULL DEFAULT E'PENDING',
PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "Order.stripePaymentIntentId_unique" ON "public"."Order"("stripePaymentIntentId")

ALTER TABLE "public"."CartToProduct" ADD FOREIGN KEY ("cartId")REFERENCES "public"."Cart"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CartToProduct" ADD FOREIGN KEY ("productId")REFERENCES "public"."Product"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200915140959-add_cart..20200930170713-add-order
--- datamodel.dml
+++ datamodel.dml
@@ -1,11 +1,12 @@
 generator client {
   provider = "prisma-client-js"
+  previewFeatures = ["atomicNumberOperations"]
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model User {
   id Int @default(autoincrement()) @id
@@ -82,4 +83,26 @@
   createdAt DateTime @default(now())
   updatedAt DateTime @default(now()) @updatedAt
 }
+
+model Order {
+  id String @default(uuid()) @id
+  cart Json
+  
+  total Int
+  stripePaymentIntentId String? @unique
+
+  // @todo add address
+
+  status OrderStatus @default(PENDING)
+}
+
+enum OrderStatus {
+  PENDING
+  PROCESSING
+  ON_HOLD
+  COMPLETED
+  CANCELLED
+  REFUNDED
+  FAILED
+}
```


