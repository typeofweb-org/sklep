# Migration `20201029164047-mvp`

This migration has been generated by Michal Miszczyszyn at 10/29/2020, 5:40:47 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."UserRole" AS ENUM ('USER', 'ADMIN')

CREATE TYPE "public"."ProductType" AS ENUM ('SINGLE', 'BUNDLE')

CREATE TYPE "public"."OrderStatus" AS ENUM ('PENDING', 'PROCESSING', 'ON_HOLD', 'COMPLETED', 'CANCELLED', 'REFUNDED', 'FAILED')

CREATE TABLE "public"."User" (
"id" SERIAL,
"name" text   ,
"email" text   NOT NULL ,
"password" text   NOT NULL ,
"role" "UserRole"  NOT NULL DEFAULT E'USER',
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Session" (
"id" text   NOT NULL ,
"validUntil" timestamp(3)   NOT NULL ,
"userId" integer   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Product" (
"id" SERIAL,
"name" text   NOT NULL ,
"slug" text   NOT NULL ,
"description" text   NOT NULL ,
"isPublic" boolean   NOT NULL DEFAULT false,
"regularPrice" integer   NOT NULL ,
"discountPrice" integer   ,
"type" "ProductType"  NOT NULL DEFAULT E'SINGLE',
"userId" integer   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Cart" (
"id" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."CartToProduct" (
"cartId" text   NOT NULL ,
"productId" integer   NOT NULL ,
"quantity" integer   NOT NULL DEFAULT 1,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("cartId","productId")
)

CREATE TABLE "public"."Order" (
"id" text   NOT NULL ,
"cart" jsonb   NOT NULL ,
"total" integer   NOT NULL ,
"stripePaymentIntentId" text   ,
"status" "OrderStatus"  NOT NULL DEFAULT E'PENDING',
PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "User.email_unique" ON "public"."User"("email")

CREATE UNIQUE INDEX "Product.name_unique" ON "public"."Product"("name")

CREATE UNIQUE INDEX "Product.slug_unique" ON "public"."Product"("slug")

CREATE UNIQUE INDEX "Order.stripePaymentIntentId_unique" ON "public"."Order"("stripePaymentIntentId")

ALTER TABLE "public"."Session" ADD FOREIGN KEY("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Product" ADD FOREIGN KEY("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CartToProduct" ADD FOREIGN KEY("cartId")REFERENCES "public"."Cart"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CartToProduct" ADD FOREIGN KEY("productId")REFERENCES "public"."Product"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20201029164047-mvp
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,108 @@
+generator client {
+  provider = "prisma-client-js"
+  previewFeatures = ["atomicNumberOperations"]
+}
+
+datasource db {
+  provider = "postgresql"
+  url = "***"
+}
+
+model User {
+  id Int @default(autoincrement()) @id
+  name String?
+  email String @unique
+  password String
+  
+  role UserRole @default(USER)
+
+  createdAt DateTime @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
+}
+
+model Session {
+  id String @id
+  validUntil DateTime
+
+  userId Int
+  user User @relation(fields: [userId], references: [id])
+
+  createdAt DateTime @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
+}
+
+enum UserRole {
+  USER
+  ADMIN
+}
+
+model Product {
+  id Int @default(autoincrement()) @id
+  name String @unique
+  slug String @unique
+  description String
+  isPublic Boolean @default(false)
+  
+  regularPrice Int
+  discountPrice Int?
+
+  type ProductType @default(SINGLE)
+
+  userId Int
+  addedBy User @relation(fields: [userId], references: [id])
+
+  createdAt DateTime @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
+}
+
+enum ProductType {
+  SINGLE
+  BUNDLE // @todo
+}
+
+
+model Cart {
+  id String @default(cuid()) @id
+
+  cartProducts CartToProduct[]
+
+  createdAt DateTime @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
+}
+
+model CartToProduct {
+  @@id([cartId, productId])
+
+  cart Cart @relation(fields: [cartId], references: [id])
+  cartId String
+
+  product Product @relation(fields: [productId], references: [id])
+  productId Int
+
+  quantity Int @default(1)
+
+  createdAt DateTime @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
+}
+
+model Order {
+  id String @default(uuid()) @id
+  cart Json
+  
+  total Int
+  stripePaymentIntentId String? @unique
+
+  // @todo add address
+
+  status OrderStatus @default(PENDING)
+}
+
+enum OrderStatus {
+  PENDING
+  PROCESSING
+  ON_HOLD
+  COMPLETED
+  CANCELLED
+  REFUNDED
+  FAILED
+}
```


